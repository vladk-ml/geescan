<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>SAR AOI Manager Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" type="text/css">
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #timeline {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: sans-serif;
            z-index: 1;
            display: none;
        }
        .timeline-content {
            display: flex;
            gap: 20px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="timeline">
        <div class="timeline-content">
            <div>Date Range: <span id="date-range">No dates available</span></div>
            <div>Images: <span id="image-count">0</span></div>
        </div>
    </div>

    <script>
        // Initialize web channel
        let channel;
        new QWebChannel(qt.webChannelTransport, function(ch) {
            channel = ch;
            // Register Python callback
            if (channel.objects.callback) {
                window.pythonCallback = function(type, data) {
                    channel.objects.callback.handleMessage(type, data);
                };
            }
        });

        // Initialize the map with a basic style
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {},
                layers: [
                    {
                        id: 'background',
                        type: 'background',
                        paint: {
                            'background-color': '#f8f8f8'
                        }
                    },
                    {
                        id: 'grid',
                        type: 'line',
                        source: {
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: generateGrid()
                            }
                        },
                        paint: {
                            'line-color': '#ddd',
                            'line-width': 1
                        }
                    }
                ]
            },
            center: [0, 0],
            zoom: 2
        });

        // Generate a grid of lines
        function generateGrid() {
            const features = [];
            
            // Meridians
            for (let lon = -180; lon <= 180; lon += 30) {
                features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [[lon, -90], [lon, 90]]
                    }
                });
            }
            
            // Parallels
            for (let lat = -90; lat <= 90; lat += 30) {
                features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [[-180, lat], [180, lat]]
                    }
                });
            }
            
            return features;
        }

        // Initialize the drawing tools
        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true
            }
        });
        map.addControl(draw);

        // Update timeline
        function updateTimeline(dates, count) {
            if (dates && dates.length > 0) {
                const start = new Date(dates[0]).toLocaleDateString();
                const end = new Date(dates[dates.length - 1]).toLocaleDateString();
                document.getElementById('date-range').textContent = `${start} - ${end}`;
                document.getElementById('image-count').textContent = count || '0';
                document.getElementById('timeline').style.display = 'block';
            } else {
                document.getElementById('timeline').style.display = 'none';
            }
        }

        // Set AOI on map
        function setAOI(geojson) {
            draw.deleteAll();
            draw.add(geojson);
        }

        // Clear AOI from map
        function clearAOI() {
            draw.deleteAll();
        }

        // Enable/disable drawing
        function enableDrawing() {
            draw.changeMode('draw_polygon');
        }

        function disableDrawing() {
            draw.changeMode('simple_select');
        }

        // Listen for drawing events
        map.on('draw.create', function(e) {
            if (window.pythonCallback) {
                window.pythonCallback('geometry', e.features[0].geometry);
            }
        });

        // Listen for map movement
        map.on('moveend', function() {
            const bounds = map.getBounds();
            if (window.pythonCallback) {
                window.pythonCallback('bounds', {
                    north: bounds.getNorth(),
                    south: bounds.getSouth(),
                    east: bounds.getEast(),
                    west: bounds.getWest()
                });
            }
        });
    </script>
</body>
</html>
